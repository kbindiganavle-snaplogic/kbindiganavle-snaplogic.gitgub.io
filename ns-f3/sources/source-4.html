


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > JMSAccount</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/highlight-idea.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.snaplogic.snaps.jms</a>
</div>

<h1>Coverage Summary for Class: JMSAccount (com.snaplogic.snaps.jms)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">JMSAccount</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/318)
  </span>
</td>
</tr>
  <tr>
    <td class="name">JMSAccount$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JMSAccount$SessionCountTracker</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JMSAccount$SessionType</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/25)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/328)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<div class="sourceCode" id="sourceCode"><i class="no-highlight">1</i>&nbsp;/*
<i class="no-highlight">2</i>&nbsp; * SnapLogic - Data Integration
<i class="no-highlight">3</i>&nbsp; *
<i class="no-highlight">4</i>&nbsp; * Copyright (C) 2013, SnapLogic, Inc.  All rights reserved.
<i class="no-highlight">5</i>&nbsp; *
<i class="no-highlight">6</i>&nbsp; * This program is licensed under the terms of
<i class="no-highlight">7</i>&nbsp; * the SnapLogic Commercial Subscription agreement.
<i class="no-highlight">8</i>&nbsp; *
<i class="no-highlight">9</i>&nbsp; * &quot;SnapLogic&quot; is a trademark of SnapLogic, Inc.
<i class="no-highlight">10</i>&nbsp; */
<i class="no-highlight">11</i>&nbsp;
<i class="no-highlight">12</i>&nbsp;package com.snaplogic.snaps.jms;
<i class="no-highlight">13</i>&nbsp;
<i class="no-highlight">14</i>&nbsp;import com.google.common.base.Throwables;
<i class="no-highlight">15</i>&nbsp;import com.google.common.cache.CacheBuilder;
<i class="no-highlight">16</i>&nbsp;import com.google.common.cache.CacheLoader;
<i class="no-highlight">17</i>&nbsp;import com.google.common.cache.LoadingCache;
<i class="no-highlight">18</i>&nbsp;import com.google.common.collect.ImmutableList;
<i class="no-highlight">19</i>&nbsp;import com.google.common.collect.ImmutableMap;
<i class="no-highlight">20</i>&nbsp;import com.google.inject.Inject;
<i class="no-highlight">21</i>&nbsp;import com.jayway.jsonpath.JsonPath;
<i class="no-highlight">22</i>&nbsp;import com.snaplogic.account.api.AccountType;
<i class="no-highlight">23</i>&nbsp;import com.snaplogic.account.api.ValidatableAccount;
<i class="no-highlight">24</i>&nbsp;import com.snaplogic.account.api.capabilities.AccountCategory;
<i class="no-highlight">25</i>&nbsp;import com.snaplogic.api.ConfigurationException;
<i class="no-highlight">26</i>&nbsp;import com.snaplogic.api.SnapException;
<i class="no-highlight">27</i>&nbsp;import com.snaplogic.common.Constants;
<i class="no-highlight">28</i>&nbsp;import com.snaplogic.common.SnapType;
<i class="no-highlight">29</i>&nbsp;import com.snaplogic.common.properties.SnapProperty;
<i class="no-highlight">30</i>&nbsp;import com.snaplogic.common.properties.builders.PropertyBuilder;
<i class="no-highlight">31</i>&nbsp;import com.snaplogic.common.utilities.URLEncoder;
<i class="no-highlight">32</i>&nbsp;import com.snaplogic.snap.api.ExpressionProperty;
<i class="no-highlight">33</i>&nbsp;import com.snaplogic.snap.api.PropertyValues;
<i class="no-highlight">34</i>&nbsp;import com.snaplogic.snap.api.SnapDataException;
<i class="no-highlight">35</i>&nbsp;import com.snaplogic.snap.api.capabilities.General;
<i class="no-highlight">36</i>&nbsp;import com.snaplogic.snap.api.capabilities.Version;
<i class="no-highlight">37</i>&nbsp;import com.snaplogic.snaps.jms.util.AdministeredObjectsUtil;
<i class="no-highlight">38</i>&nbsp;import com.snaplogic.util.JsonPathBuilder;
<i class="no-highlight">39</i>&nbsp;
<i class="no-highlight">40</i>&nbsp;import org.apache.commons.collections.CollectionUtils;
<i class="no-highlight">41</i>&nbsp;import org.apache.commons.lang3.StringUtils;
<i class="no-highlight">42</i>&nbsp;import org.slf4j.Logger;
<i class="no-highlight">43</i>&nbsp;import org.slf4j.LoggerFactory;
<i class="no-highlight">44</i>&nbsp;
<i class="no-highlight">45</i>&nbsp;import java.net.MalformedURLException;
<i class="no-highlight">46</i>&nbsp;import java.net.URL;
<i class="no-highlight">47</i>&nbsp;import java.util.ArrayList;
<i class="no-highlight">48</i>&nbsp;import java.util.HashMap;
<i class="no-highlight">49</i>&nbsp;import java.util.List;
<i class="no-highlight">50</i>&nbsp;import java.util.Map;
<i class="no-highlight">51</i>&nbsp;import java.util.Properties;
<i class="no-highlight">52</i>&nbsp;import java.util.Set;
<i class="no-highlight">53</i>&nbsp;import java.util.UUID;
<i class="no-highlight">54</i>&nbsp;import java.util.concurrent.ConcurrentHashMap;
<i class="no-highlight">55</i>&nbsp;import java.util.concurrent.ExecutorService;
<i class="no-highlight">56</i>&nbsp;import java.util.concurrent.Executors;
<i class="no-highlight">57</i>&nbsp;import java.util.concurrent.Future;
<i class="no-highlight">58</i>&nbsp;import java.util.concurrent.TimeUnit;
<i class="no-highlight">59</i>&nbsp;import java.util.concurrent.locks.Lock;
<i class="no-highlight">60</i>&nbsp;import java.util.concurrent.locks.ReentrantLock;
<i class="no-highlight">61</i>&nbsp;
<i class="no-highlight">62</i>&nbsp;import javax.jms.Connection;
<i class="no-highlight">63</i>&nbsp;import javax.jms.ConnectionFactory;
<i class="no-highlight">64</i>&nbsp;import javax.jms.JMSException;
<i class="no-highlight">65</i>&nbsp;import javax.jms.Session;
<i class="no-highlight">66</i>&nbsp;import javax.naming.Context;
<i class="no-highlight">67</i>&nbsp;
<i class="no-highlight">68</i>&nbsp;import static com.snaplogic.snaps.jms.Messages.*;
<i class="no-highlight">69</i>&nbsp;
<i class="no-highlight">70</i>&nbsp;/**
<i class="no-highlight">71</i>&nbsp; * A Generic account for JMS snaps
<i class="no-highlight">72</i>&nbsp; *
<i class="no-highlight">73</i>&nbsp; * @author slad@snaplogic.com (Samarth Lad), smudassir@snaplogic.com
<i class="no-highlight">74</i>&nbsp; */
<i class="no-highlight">75</i>&nbsp;@General(title = JMS_ACCOUNT_TITLE, docLink = JMS_ACCOUNT_DOC_LINK)
<i class="no-highlight">76</i>&nbsp;@Version(snap = 1)
<i class="no-highlight">77</i>&nbsp;@AccountCategory(type = AccountType.BASIC_AUTH)
<b class="nc"><i class="no-highlight">78</i>&nbsp;public class JMSAccount implements ValidatableAccount&lt;Session&gt; {</b>
<b class="nc"><i class="no-highlight">79</i>&nbsp;    private static final Map&lt;String, ClassLoader&gt; CLASS_LOADERS = new HashMap&lt;&gt;();</b>
<i class="no-highlight">80</i>&nbsp;    private static final String JAR_FILE_PROP = &quot;JarFile&quot;;
<i class="no-highlight">81</i>&nbsp;    private static final String JARS_TABLE_PROP = &quot;JarsTable&quot;;
<b class="nc"><i class="no-highlight">82</i>&nbsp;    private static final Logger LOG = LoggerFactory.getLogger(JMSAccount.class);</b>
<b class="nc"><i class="no-highlight">83</i>&nbsp;    private static final String JNDI_PROPERTY_NAME_PATH = new JsonPathBuilder(</b>
<b class="nc"><i class="no-highlight">84</i>&nbsp;            JNDI_PROPERTY_NAME_PROP).appendValueElement().build();</b>
<b class="nc"><i class="no-highlight">85</i>&nbsp;    private static final String JNDI_PROPERTY_VALUE_PATH = new JsonPathBuilder(</b>
<b class="nc"><i class="no-highlight">86</i>&nbsp;            JNDI_PROPERTY_VALUE_PROP).appendValueElement().build();</b>
<b class="nc"><i class="no-highlight">87</i>&nbsp;    private static final List&lt;Object&gt; DEFAULT_TABLE_VALUES = ImmutableList.builder()</b>
<b class="nc"><i class="no-highlight">88</i>&nbsp;            .add(ImmutableMap.builder()</b>
<b class="nc"><i class="no-highlight">89</i>&nbsp;                    .put(Constants.SNAP_PROPERTY_VALUE, StringUtils.EMPTY)</b>
<b class="nc"><i class="no-highlight">90</i>&nbsp;                    .build())</b>
<b class="nc"><i class="no-highlight">91</i>&nbsp;            .build();</b>
<i class="no-highlight">92</i>&nbsp;    private static final String PIPE_SEPARATOR = &quot;|&quot;;
<i class="no-highlight">93</i>&nbsp;    private static final LoadingCache&lt;Map&lt;String, String&gt;,
<i class="no-highlight">94</i>&nbsp;            Map&lt;String, Connection&gt;&gt; JMS_CONNECTIONS_CACHE;
<b class="nc"><i class="no-highlight">95</i>&nbsp;    private static final Map&lt;String, SessionCountTracker&gt; SESSIONS_PER_CONNECTION =</b>
<i class="no-highlight">96</i>&nbsp;            new ConcurrentHashMap&lt;&gt;();
<i class="no-highlight">97</i>&nbsp;    private static final String USERNAME = &quot;username&quot;;
<i class="no-highlight">98</i>&nbsp;    private static final String PASSWORD = &quot;password&quot;;
<i class="no-highlight">99</i>&nbsp;    private static final String CONNECTION_FACTORY_NAME = &quot;connectionFactoryName&quot;;
<i class="no-highlight">100</i>&nbsp;    private static final String CLIENT_ID_UNKNOWN = &quot;unknown&quot;;
<i class="no-highlight">101</i>&nbsp;
<i class="no-highlight">102</i>&nbsp;    /**
<i class="no-highlight">103</i>&nbsp;     * Enum to track session types
<i class="no-highlight">104</i>&nbsp;     */
<b class="nc"><i class="no-highlight">105</i>&nbsp;    private enum SessionType {</b>
<b class="nc"><i class="no-highlight">106</i>&nbsp;        DATA,</b>
<b class="nc"><i class="no-highlight">107</i>&nbsp;        CONTROL</b>
<i class="no-highlight">108</i>&nbsp;    }
<i class="no-highlight">109</i>&nbsp;
<i class="no-highlight">110</i>&nbsp;    /**
<i class="no-highlight">111</i>&nbsp;     * Custom class to keep track of no of sessions for a JMS connection
<i class="no-highlight">112</i>&nbsp;     */
<b class="nc"><i class="no-highlight">113</i>&nbsp;    private class SessionCountTracker {</b>
<b class="nc"><i class="no-highlight">114</i>&nbsp;        private int sessionsCount = 1;</b>
<i class="no-highlight">115</i>&nbsp;
<i class="no-highlight">116</i>&nbsp;        public void incr() {
<b class="nc"><i class="no-highlight">117</i>&nbsp;            sessionsCount++;</b>
<i class="no-highlight">118</i>&nbsp;        }
<i class="no-highlight">119</i>&nbsp;
<i class="no-highlight">120</i>&nbsp;        public void decr() {
<b class="nc"><i class="no-highlight">121</i>&nbsp;            sessionsCount--;</b>
<i class="no-highlight">122</i>&nbsp;        }
<i class="no-highlight">123</i>&nbsp;
<i class="no-highlight">124</i>&nbsp;        public int getCount() {
<b class="nc"><i class="no-highlight">125</i>&nbsp;            return sessionsCount;</b>
<i class="no-highlight">126</i>&nbsp;        }
<i class="no-highlight">127</i>&nbsp;    }
<i class="no-highlight">128</i>&nbsp;
<i class="no-highlight">129</i>&nbsp;    @Inject
<i class="no-highlight">130</i>&nbsp;    private AdministeredObjectsUtil administeredObjectsUtil;
<i class="no-highlight">131</i>&nbsp;    @Inject
<i class="no-highlight">132</i>&nbsp;    private URLEncoder urlEncoder;
<i class="no-highlight">133</i>&nbsp;
<b class="nc"><i class="no-highlight">134</i>&nbsp;    private static final Lock LOCK = new ReentrantLock();</b>
<i class="no-highlight">135</i>&nbsp;
<i class="no-highlight">136</i>&nbsp;    private String connectionFactoryName;
<i class="no-highlight">137</i>&nbsp;    private String username;
<i class="no-highlight">138</i>&nbsp;    private String password;
<i class="no-highlight">139</i>&nbsp;    private ConnectionFactory connectionFactory;
<i class="no-highlight">140</i>&nbsp;    protected Map&lt;String, String&gt; connectionProperties;
<b class="nc"><i class="no-highlight">141</i>&nbsp;    private String[] sessionsConnectionID = new String[SessionType.values().length];</b>
<b class="nc"><i class="no-highlight">142</i>&nbsp;    private Session[] sessions = new Session[SessionType.values().length];</b>
<i class="no-highlight">143</i>&nbsp;    private boolean isTransacted;
<b class="nc"><i class="no-highlight">144</i>&nbsp;    private int ackMode = Session.AUTO_ACKNOWLEDGE;</b>
<i class="no-highlight">145</i>&nbsp;    private String clientID;
<i class="no-highlight">146</i>&nbsp;    private boolean durableSubscriber;
<i class="no-highlight">147</i>&nbsp;    private boolean controlSessionRequired;
<i class="no-highlight">148</i>&nbsp;    private boolean asyncMode;
<i class="no-highlight">149</i>&nbsp;    private Connection connection; // will be used for async mode only
<i class="no-highlight">150</i>&nbsp;
<i class="no-highlight">151</i>&nbsp;    // Google Guava Cache that holds all connections for a given configuration
<i class="no-highlight">152</i>&nbsp;    static {
<i class="no-highlight">153</i>&nbsp;        JMS_CONNECTIONS_CACHE = CacheBuilder
<b class="nc"><i class="no-highlight">154</i>&nbsp;                .newBuilder()</b>
<b class="nc"><i class="no-highlight">155</i>&nbsp;                .build(new CacheLoader&lt;Map&lt;String, String&gt;, Map&lt;String, Connection&gt;&gt;() {</b>
<i class="no-highlight">156</i>&nbsp;                    @Override
<i class="no-highlight">157</i>&nbsp;                    public Map&lt;String, Connection&gt; load(Map&lt;String, String&gt; connectionProps) throws
<i class="no-highlight">158</i>&nbsp;                            Exception {
<b class="nc"><i class="no-highlight">159</i>&nbsp;                        return new ConcurrentHashMap&lt;&gt;();</b>
<i class="no-highlight">160</i>&nbsp;                    }
<i class="no-highlight">161</i>&nbsp;                });
<i class="no-highlight">162</i>&nbsp;    }
<i class="no-highlight">163</i>&nbsp;
<i class="no-highlight">164</i>&nbsp;    @Override
<i class="no-highlight">165</i>&nbsp;    public void defineProperties(final PropertyBuilder propertyBuilder) {
<b class="nc"><i class="no-highlight">166</i>&nbsp;        propertyBuilder.describe(USERNAME_PROP, USERNAME_LABEL, USERNAME_DESCRIPTION)</b>
<b class="nc"><i class="no-highlight">167</i>&nbsp;                .sensitivity(SnapProperty.SensitivityLevel.MEDIUM)</b>
<b class="nc"><i class="no-highlight">168</i>&nbsp;                .dataLocationIdentifier(&quot;jms.username&quot;)</b>
<b class="nc"><i class="no-highlight">169</i>&nbsp;                .add();</b>
<b class="nc"><i class="no-highlight">170</i>&nbsp;        propertyBuilder.describe(PASSWORD_PROP, PASSWORD_LABEL, PASSWORD_DESCRIPTION)</b>
<b class="nc"><i class="no-highlight">171</i>&nbsp;                .obfuscate()</b>
<b class="nc"><i class="no-highlight">172</i>&nbsp;                .add();</b>
<b class="nc"><i class="no-highlight">173</i>&nbsp;        propertyBuilder.describe(CONNECTION_FACTORY_NAME_PROP, CONNECTION_FACTORY_NAME_LABEL,</b>
<i class="no-highlight">174</i>&nbsp;                CONNECTION_FACTORY_NAME_DESCRIPTION)
<b class="nc"><i class="no-highlight">175</i>&nbsp;                .required()</b>
<b class="nc"><i class="no-highlight">176</i>&nbsp;                .sensitivity(SnapProperty.SensitivityLevel.LOW)</b>
<b class="nc"><i class="no-highlight">177</i>&nbsp;                .add();</b>
<b class="nc"><i class="no-highlight">178</i>&nbsp;        SnapProperty jndiPropertyName = propertyBuilder.describe(JNDI_PROPERTY_NAME_PROP,</b>
<i class="no-highlight">179</i>&nbsp;                JNDI_PROPERTY_NAME_LABEL, JNDI_PROPERTY_NAME_DESCRIPTION)
<b class="nc"><i class="no-highlight">180</i>&nbsp;                .required()</b>
<b class="nc"><i class="no-highlight">181</i>&nbsp;                .build();</b>
<b class="nc"><i class="no-highlight">182</i>&nbsp;        SnapProperty jndiPropertyValue = propertyBuilder.describe(JNDI_PROPERTY_VALUE_PROP,</b>
<i class="no-highlight">183</i>&nbsp;                JNDI_PROPERTY_VALUE_LABEL, JNDI_PROPERTY_VALUE_DESCRIPTION)
<b class="nc"><i class="no-highlight">184</i>&nbsp;                .required()</b>
<b class="nc"><i class="no-highlight">185</i>&nbsp;                .sensitivity(SnapProperty.SensitivityLevel.LOW)</b>
<b class="nc"><i class="no-highlight">186</i>&nbsp;                .build();</b>
<b class="nc"><i class="no-highlight">187</i>&nbsp;        propertyBuilder.describe(JNDI_PROPERTIES_PROP, JNDI_PROPERTIES_LABEL,</b>
<i class="no-highlight">188</i>&nbsp;                JNDI_PROPERTIES_DESCRIPTION)
<b class="nc"><i class="no-highlight">189</i>&nbsp;                .type(SnapType.TABLE)</b>
<b class="nc"><i class="no-highlight">190</i>&nbsp;                .required()</b>
<b class="nc"><i class="no-highlight">191</i>&nbsp;                .withEntry(jndiPropertyName)</b>
<b class="nc"><i class="no-highlight">192</i>&nbsp;                .withEntry(jndiPropertyValue)</b>
<b class="nc"><i class="no-highlight">193</i>&nbsp;                .add();</b>
<b class="nc"><i class="no-highlight">194</i>&nbsp;        SnapProperty jar = propertyBuilder.describe(JAR_FILE_PROP, JAR_FILE_LABEL,</b>
<i class="no-highlight">195</i>&nbsp;                JAR_FILE_DESCRIPTION)
<b class="nc"><i class="no-highlight">196</i>&nbsp;                .fileBrowsing()</b>
<b class="nc"><i class="no-highlight">197</i>&nbsp;                .build();</b>
<b class="nc"><i class="no-highlight">198</i>&nbsp;        propertyBuilder.describe(JARS_TABLE_PROP, JARS_TABLE_LABEL, JARS_TABLE_DESCRIPTION)</b>
<b class="nc"><i class="no-highlight">199</i>&nbsp;                .type(SnapType.TABLE)</b>
<b class="nc"><i class="no-highlight">200</i>&nbsp;                .withEntry(jar)</b>
<b class="nc"><i class="no-highlight">201</i>&nbsp;                .defaultValue(DEFAULT_TABLE_VALUES)</b>
<b class="nc"><i class="no-highlight">202</i>&nbsp;                .add();</b>
<i class="no-highlight">203</i>&nbsp;    }
<i class="no-highlight">204</i>&nbsp;
<i class="no-highlight">205</i>&nbsp;    @Override
<i class="no-highlight">206</i>&nbsp;    public Session connect() throws SnapDataException {
<b class="nc"><i class="no-highlight">207</i>&nbsp;        if (asyncMode) {</b>
<i class="no-highlight">208</i>&nbsp;            // Better to have separate distinct connection for async mode as we have to add
<i class="no-highlight">209</i>&nbsp;            //   exception listener to handle async failures
<b class="nc"><i class="no-highlight">210</i>&nbsp;            connection = createConnection();</b>
<i class="no-highlight">211</i>&nbsp;            try {
<b class="nc"><i class="no-highlight">212</i>&nbsp;                connection.start();</b>
<b class="nc"><i class="no-highlight">213</i>&nbsp;            } catch (JMSException e1) {</b>
<b class="nc"><i class="no-highlight">214</i>&nbsp;                throw new SnapDataException(e1, ERROR_WHILE_STARTING_CONNECTION)</b>
<b class="nc"><i class="no-highlight">215</i>&nbsp;                        .withResolution(CONNECTION_START_RESOLUTION);</b>
<b class="nc"><i class="no-highlight">216</i>&nbsp;            }</b>
<b class="nc"><i class="no-highlight">217</i>&nbsp;            sessions[0] = createSession(connection, isTransacted, ackMode);</b>
<b class="nc"><i class="no-highlight">218</i>&nbsp;            if (controlSessionRequired) {</b>
<b class="nc"><i class="no-highlight">219</i>&nbsp;                sessions[1] = createSession(connection, false, Session.AUTO_ACKNOWLEDGE);</b>
<i class="no-highlight">220</i>&nbsp;            }
<i class="no-highlight">221</i>&nbsp;        } else {
<i class="no-highlight">222</i>&nbsp;            // In sync mode, its ok to share connections across various JMS snaps
<b class="nc"><i class="no-highlight">223</i>&nbsp;            createSessionRequest(SessionType.DATA, isTransacted, ackMode);</b>
<b class="nc"><i class="no-highlight">224</i>&nbsp;            if (controlSessionRequired) {</b>
<b class="nc"><i class="no-highlight">225</i>&nbsp;                createSessionRequest(SessionType.CONTROL, false, Session.AUTO_ACKNOWLEDGE);</b>
<i class="no-highlight">226</i>&nbsp;            }
<i class="no-highlight">227</i>&nbsp;        }
<b class="nc"><i class="no-highlight">228</i>&nbsp;        return sessions[0];</b>
<i class="no-highlight">229</i>&nbsp;    }
<i class="no-highlight">230</i>&nbsp;
<i class="no-highlight">231</i>&nbsp;    /**
<i class="no-highlight">232</i>&nbsp;     * Creates a session and sets the appropriate instance variables based on sessionType
<i class="no-highlight">233</i>&nbsp;     *
<i class="no-highlight">234</i>&nbsp;     * @param sessionType
<i class="no-highlight">235</i>&nbsp;     */
<i class="no-highlight">236</i>&nbsp;    private void createSessionRequest(SessionType sessionType, boolean isTransacted, int ackMode)
<i class="no-highlight">237</i>&nbsp;            throws SnapDataException {
<i class="no-highlight">238</i>&nbsp;        Map&lt;String, Connection&gt; jmsConnections;
<i class="no-highlight">239</i>&nbsp;
<i class="no-highlight">240</i>&nbsp;        // Fetch the map that holds all connections for the given account properties
<i class="no-highlight">241</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">242</i>&nbsp;            jmsConnections = JMS_CONNECTIONS_CACHE.get(connectionProperties);</b>
<b class="nc"><i class="no-highlight">243</i>&nbsp;        } catch (java.util.concurrent.ExecutionException e1) {</b>
<b class="nc"><i class="no-highlight">244</i>&nbsp;            LOG.error(&quot;Exception occurred while loading connections from the cache&quot;, e1);</b>
<b class="nc"><i class="no-highlight">245</i>&nbsp;            throw new SnapDataException(e1, ERROR_LOAD_FROM_CACHE_MSG)</b>
<b class="nc"><i class="no-highlight">246</i>&nbsp;                    .withReason(e1.getMessage())</b>
<b class="nc"><i class="no-highlight">247</i>&nbsp;                    .withResolution(ERROR_LOAD_FROM_CACHE_RESOLUTION);</b>
<b class="nc"><i class="no-highlight">248</i>&nbsp;        }</b>
<i class="no-highlight">249</i>&nbsp;
<i class="no-highlight">250</i>&nbsp;        String connectionID;
<i class="no-highlight">251</i>&nbsp;        Session session;
<b class="nc"><i class="no-highlight">252</i>&nbsp;        Connection connection = null;</b>
<i class="no-highlight">253</i>&nbsp;
<i class="no-highlight">254</i>&nbsp;        // All the threads having same connection properties will be allowed one at a time for
<i class="no-highlight">255</i>&nbsp;        //  getting a session
<b class="nc"><i class="no-highlight">256</i>&nbsp;        synchronized (jmsConnections) {</b>
<i class="no-highlight">257</i>&nbsp;            // Get all the available connections for the given configuration
<b class="nc"><i class="no-highlight">258</i>&nbsp;            Set&lt;Map.Entry&lt;String, Connection&gt;&gt; connectionEntries = jmsConnections.entrySet();</b>
<i class="no-highlight">259</i>&nbsp;
<i class="no-highlight">260</i>&nbsp;            // Attempt to reuse any of the existing connections (if available) obtained above
<b class="nc"><i class="no-highlight">261</i>&nbsp;            for (Map.Entry&lt;String, Connection&gt; connectionEntry : connectionEntries) {</b>
<b class="nc"><i class="no-highlight">262</i>&nbsp;                connectionID = connectionEntry.getKey();</b>
<b class="nc"><i class="no-highlight">263</i>&nbsp;                connection = connectionEntry.getValue();</b>
<i class="no-highlight">264</i>&nbsp;
<i class="no-highlight">265</i>&nbsp;                // Check if the connection&#39;s client ID matches
<i class="no-highlight">266</i>&nbsp;                try {
<b class="nc"><i class="no-highlight">267</i>&nbsp;                    if (durableSubscriber &amp;&amp; StringUtils.isNotBlank(clientID) &amp;&amp;</b>
<b class="nc"><i class="no-highlight">268</i>&nbsp;                            !StringUtils.equals(clientID, connection.getClientID())) {</b>
<i class="no-highlight">269</i>&nbsp;                        // client ID not matching, try next entry
<b class="nc"><i class="no-highlight">270</i>&nbsp;                        continue;</b>
<i class="no-highlight">271</i>&nbsp;                    }
<b class="nc"><i class="no-highlight">272</i>&nbsp;                } catch (JMSException e7) {</b>
<b class="nc"><i class="no-highlight">273</i>&nbsp;                    LOG.error(String.format(ERROR_WHILE_RETRIEVING_CONNECTION_CLIENT_ID,</b>
<b class="nc"><i class="no-highlight">274</i>&nbsp;                            connectionProperties.get(Context.PROVIDER_URL)), e7);</b>
<b class="nc"><i class="no-highlight">275</i>&nbsp;                    continue;</b>
<b class="nc"><i class="no-highlight">276</i>&nbsp;                }</b>
<i class="no-highlight">277</i>&nbsp;
<b class="nc"><i class="no-highlight">278</i>&nbsp;                if (StringUtils.isBlank(clientID) || !durableSubscriber) {</b>
<i class="no-highlight">279</i>&nbsp;                    // Get the client ID of the connection for logging purpose
<i class="no-highlight">280</i>&nbsp;                    try {
<b class="nc"><i class="no-highlight">281</i>&nbsp;                        clientID = connection.getClientID();</b>
<b class="nc"><i class="no-highlight">282</i>&nbsp;                    } catch (JMSException e3) {</b>
<b class="nc"><i class="no-highlight">283</i>&nbsp;                        clientID = CLIENT_ID_UNKNOWN;</b>
<b class="nc"><i class="no-highlight">284</i>&nbsp;                        LOG.error(&quot;Unable to fetch the Client ID of the used connection for the &quot; +</b>
<b class="nc"><i class="no-highlight">285</i>&nbsp;                                &quot;host: &#39;{}&#39; &quot;, connectionProperties.get(</b>
<i class="no-highlight">286</i>&nbsp;                                Context.PROVIDER_URL), e3);
<b class="nc"><i class="no-highlight">287</i>&nbsp;                    }</b>
<i class="no-highlight">288</i>&nbsp;                }
<i class="no-highlight">289</i>&nbsp;
<i class="no-highlight">290</i>&nbsp;                // Obtain a session from the connection fetched
<i class="no-highlight">291</i>&nbsp;                try {
<b class="nc"><i class="no-highlight">292</i>&nbsp;                    session = createSession(connection, isTransacted, ackMode);</b>
<i class="no-highlight">293</i>&nbsp;                    // Update the sessions count for the connection
<b class="nc"><i class="no-highlight">294</i>&nbsp;                    SESSIONS_PER_CONNECTION.get(connectionID).incr();</b>
<b class="nc"><i class="no-highlight">295</i>&nbsp;                    sessions[sessionType.ordinal()] = session;</b>
<b class="nc"><i class="no-highlight">296</i>&nbsp;                    sessionsConnectionID[sessionType.ordinal()] = connectionID;</b>
<b class="nc"><i class="no-highlight">297</i>&nbsp;                    return;</b>
<b class="nc"><i class="no-highlight">298</i>&nbsp;                } catch (SnapDataException e8) {</b>
<i class="no-highlight">299</i>&nbsp;                    // Failed to obtain a session from the current connection entry
<i class="no-highlight">300</i>&nbsp;                    // We will simply proceed with the next connection entry
<b class="nc"><i class="no-highlight">301</i>&nbsp;                    continue;</b>
<i class="no-highlight">302</i>&nbsp;                }
<i class="no-highlight">303</i>&nbsp;            }
<i class="no-highlight">304</i>&nbsp;
<i class="no-highlight">305</i>&nbsp;            // Need to create a new connection because there might be no existing connections or
<i class="no-highlight">306</i>&nbsp;            //  existing connections cannot create any more sessions
<i class="no-highlight">307</i>&nbsp;            try {
<b class="nc"><i class="no-highlight">308</i>&nbsp;                connection = createConnection();</b>
<b class="nc"><i class="no-highlight">309</i>&nbsp;                LOG.info(&quot;Created a new connection instance for the host: &#39;{}&#39; bearing the &quot; +</b>
<b class="nc"><i class="no-highlight">310</i>&nbsp;                                &quot;Client ID: &#39;{}&#39;&quot;, connectionProperties.get(Context.PROVIDER_URL),</b>
<i class="no-highlight">311</i>&nbsp;                        clientID);
<i class="no-highlight">312</i>&nbsp;
<i class="no-highlight">313</i>&nbsp;                // Start the connection
<i class="no-highlight">314</i>&nbsp;                try {
<b class="nc"><i class="no-highlight">315</i>&nbsp;                    connection.start();</b>
<b class="nc"><i class="no-highlight">316</i>&nbsp;                } catch (JMSException e4) {</b>
<b class="nc"><i class="no-highlight">317</i>&nbsp;                    LOG.error(&quot;Unable to start the connection bearing the Client ID: &#39;{}&#39;&quot;,</b>
<i class="no-highlight">318</i>&nbsp;                            clientID, e4);
<b class="nc"><i class="no-highlight">319</i>&nbsp;                    throw new SnapDataException(e4, ERROR_WHILE_STARTING_CONNECTION)</b>
<b class="nc"><i class="no-highlight">320</i>&nbsp;                            .withReason(e4.getMessage())</b>
<b class="nc"><i class="no-highlight">321</i>&nbsp;                            .withResolution(CONNECTION_START_RESOLUTION);</b>
<b class="nc"><i class="no-highlight">322</i>&nbsp;                }</b>
<i class="no-highlight">323</i>&nbsp;
<i class="no-highlight">324</i>&nbsp;                // Create a session from the new connection obtained
<b class="nc"><i class="no-highlight">325</i>&nbsp;                connectionID = UUID.randomUUID().toString();</b>
<i class="no-highlight">326</i>&nbsp;                try {
<b class="nc"><i class="no-highlight">327</i>&nbsp;                    session = createSession(connection, isTransacted, ackMode);</b>
<b class="nc"><i class="no-highlight">328</i>&nbsp;                    jmsConnections.put(connectionID, connection);</b>
<i class="no-highlight">329</i>&nbsp;                    // After caching the connection, set the variable to null so that
<i class="no-highlight">330</i>&nbsp;                    //  the connection doesn&#39;t get closed
<b class="nc"><i class="no-highlight">331</i>&nbsp;                    connection = null;</b>
<i class="no-highlight">332</i>&nbsp;                    // Update the sessions count for the connection
<b class="nc"><i class="no-highlight">333</i>&nbsp;                    SESSIONS_PER_CONNECTION.put(connectionID, new SessionCountTracker());</b>
<b class="nc"><i class="no-highlight">334</i>&nbsp;                    sessions[sessionType.ordinal()] = session;</b>
<b class="nc"><i class="no-highlight">335</i>&nbsp;                    sessionsConnectionID[sessionType.ordinal()] = connectionID;</b>
<b class="nc"><i class="no-highlight">336</i>&nbsp;                } catch (SnapDataException e5) {</b>
<b class="nc"><i class="no-highlight">337</i>&nbsp;                    throw e5;</b>
<b class="nc"><i class="no-highlight">338</i>&nbsp;                }</b>
<i class="no-highlight">339</i>&nbsp;            } finally {
<i class="no-highlight">340</i>&nbsp;                // In case the connection is obtained but an error occurred subsequently,
<i class="no-highlight">341</i>&nbsp;                //  it will be closed
<b class="nc"><i class="no-highlight">342</i>&nbsp;                if (connection != null) {</b>
<i class="no-highlight">343</i>&nbsp;                    try {
<b class="nc"><i class="no-highlight">344</i>&nbsp;                        connection.close();</b>
<b class="nc"><i class="no-highlight">345</i>&nbsp;                        LOG.info(&quot;New connection bearing the client ID &#39;{}&#39; has been closed &quot; +</b>
<i class="no-highlight">346</i>&nbsp;                                &quot;without being used&quot;, clientID);
<b class="nc"><i class="no-highlight">347</i>&nbsp;                    } catch (Exception e6) {</b>
<b class="nc"><i class="no-highlight">348</i>&nbsp;                        LOG.error(String.format(ERROR_WHILE_CLOSING_CONNECTION, clientID),</b>
<i class="no-highlight">349</i>&nbsp;                                e6);
<b class="nc"><i class="no-highlight">350</i>&nbsp;                    }</b>
<i class="no-highlight">351</i>&nbsp;                }
<b class="nc"><i class="no-highlight">352</i>&nbsp;            }</b>
<b class="nc"><i class="no-highlight">353</i>&nbsp;        }</b>
<i class="no-highlight">354</i>&nbsp;    }
<i class="no-highlight">355</i>&nbsp;
<i class="no-highlight">356</i>&nbsp;    /**
<i class="no-highlight">357</i>&nbsp;     * Creates a JMS Connection for the specified provider.
<i class="no-highlight">358</i>&nbsp;     *
<i class="no-highlight">359</i>&nbsp;     * @return connection
<i class="no-highlight">360</i>&nbsp;     */
<i class="no-highlight">361</i>&nbsp;    protected Connection createConnection() throws SnapDataException {
<i class="no-highlight">362</i>&nbsp;        Connection jmsConnection;
<b class="nc"><i class="no-highlight">363</i>&nbsp;        if (StringUtils.isEmpty(username) || StringUtils.isEmpty(password)) {</b>
<i class="no-highlight">364</i>&nbsp;            try {
<b class="nc"><i class="no-highlight">365</i>&nbsp;                jmsConnection = connectionFactory.createConnection();</b>
<b class="nc"><i class="no-highlight">366</i>&nbsp;            } catch (JMSException e) {</b>
<b class="nc"><i class="no-highlight">367</i>&nbsp;                throw new SnapDataException(e, String.format(ERROR_WHILE_CREATING_CONNECTION,</b>
<i class="no-highlight">368</i>&nbsp;                        connectionFactoryName))
<b class="nc"><i class="no-highlight">369</i>&nbsp;                        .withReason(e.getMessage())</b>
<b class="nc"><i class="no-highlight">370</i>&nbsp;                        .withResolution(PLEASE_VERIFY_USER_IDENTITY);</b>
<b class="nc"><i class="no-highlight">371</i>&nbsp;            }</b>
<i class="no-highlight">372</i>&nbsp;        } else {
<i class="no-highlight">373</i>&nbsp;            try {
<b class="nc"><i class="no-highlight">374</i>&nbsp;                jmsConnection = connectionFactory.createConnection(username, password);</b>
<b class="nc"><i class="no-highlight">375</i>&nbsp;            } catch (JMSException e) {</b>
<b class="nc"><i class="no-highlight">376</i>&nbsp;                throw new SnapDataException(e, String.format(ERROR_WHILE_CREATING_CONNECTION,</b>
<i class="no-highlight">377</i>&nbsp;                        connectionFactoryName))
<b class="nc"><i class="no-highlight">378</i>&nbsp;                        .withReason(e.getMessage())</b>
<b class="nc"><i class="no-highlight">379</i>&nbsp;                        .withResolution(PLEASE_VERIFY_USER_CREDENTIALS);</b>
<b class="nc"><i class="no-highlight">380</i>&nbsp;            }</b>
<i class="no-highlight">381</i>&nbsp;        }
<i class="no-highlight">382</i>&nbsp;        // Set the client ID (if provided by the user) for the connection for
<i class="no-highlight">383</i>&nbsp;        //  durable consumers
<b class="nc"><i class="no-highlight">384</i>&nbsp;        if (StringUtils.isNotBlank(clientID) &amp;&amp; durableSubscriber) {</b>
<i class="no-highlight">385</i>&nbsp;            try {
<b class="nc"><i class="no-highlight">386</i>&nbsp;                jmsConnection.setClientID(clientID);</b>
<b class="nc"><i class="no-highlight">387</i>&nbsp;            } catch (JMSException e2) {</b>
<b class="nc"><i class="no-highlight">388</i>&nbsp;                clientID = CLIENT_ID_UNKNOWN;</b>
<b class="nc"><i class="no-highlight">389</i>&nbsp;                LOG.error(&quot;Unable to set Client ID for the new connection obtained for &quot; +</b>
<b class="nc"><i class="no-highlight">390</i>&nbsp;                                &quot;the host: &#39;{}&#39;&quot;, connectionProperties.get(Context.PROVIDER_URL),</b>
<i class="no-highlight">391</i>&nbsp;                        e2);
<b class="nc"><i class="no-highlight">392</i>&nbsp;                throw new SnapDataException(e2, ERROR_WHILE_SETTING_CLIENT_ID)</b>
<b class="nc"><i class="no-highlight">393</i>&nbsp;                        .withReason(e2.getMessage())</b>
<b class="nc"><i class="no-highlight">394</i>&nbsp;                        .withResolution(ERROR_SETTING_CONNECTION_CLIENT_ID_RESOLUTION);</b>
<b class="nc"><i class="no-highlight">395</i>&nbsp;            }</b>
<i class="no-highlight">396</i>&nbsp;        } else {
<i class="no-highlight">397</i>&nbsp;            // Get the client ID of the connection for logging purpose
<i class="no-highlight">398</i>&nbsp;            try {
<b class="nc"><i class="no-highlight">399</i>&nbsp;                clientID = jmsConnection.getClientID();</b>
<b class="nc"><i class="no-highlight">400</i>&nbsp;            } catch (JMSException e3) {</b>
<b class="nc"><i class="no-highlight">401</i>&nbsp;                clientID = CLIENT_ID_UNKNOWN;</b>
<b class="nc"><i class="no-highlight">402</i>&nbsp;                LOG.error(&quot;Unable to fetch the Client ID of the new connection obtained &quot; +</b>
<b class="nc"><i class="no-highlight">403</i>&nbsp;                        &quot;for the host: &#39;{}&#39;&quot;, connectionProperties.get(</b>
<i class="no-highlight">404</i>&nbsp;                        Context.PROVIDER_URL), e3);
<b class="nc"><i class="no-highlight">405</i>&nbsp;            }</b>
<i class="no-highlight">406</i>&nbsp;        }
<b class="nc"><i class="no-highlight">407</i>&nbsp;        return jmsConnection;</b>
<i class="no-highlight">408</i>&nbsp;    }
<i class="no-highlight">409</i>&nbsp;
<i class="no-highlight">410</i>&nbsp;    /**
<i class="no-highlight">411</i>&nbsp;     * Creates a JMS session from the given JMS Connection.
<i class="no-highlight">412</i>&nbsp;     */
<i class="no-highlight">413</i>&nbsp;    protected Session createSession(final Connection connection, boolean isTransacted, int ackMode)
<i class="no-highlight">414</i>&nbsp;            throws SnapDataException {
<i class="no-highlight">415</i>&nbsp;        // NOTE: Some JMS providers just return a fake connection. Here we try creating a session
<i class="no-highlight">416</i>&nbsp;        // out of it. If it succeeds, then we assume that the connection is valid.
<i class="no-highlight">417</i>&nbsp;
<i class="no-highlight">418</i>&nbsp;        // changed from Executors.newSingleThreadExecutor() because that is susceptible to
<i class="no-highlight">419</i>&nbsp;        // GC shutting down the thread pool as soon as it delegates the submit() call
<i class="no-highlight">420</i>&nbsp;        // see https://www.farside.org.uk/201309/learning_from_bad_code
<b class="nc"><i class="no-highlight">421</i>&nbsp;        ExecutorService threadPool = Executors.newFixedThreadPool(1);</b>
<b class="nc"><i class="no-highlight">422</i>&nbsp;        Future&lt;Session&gt; result = threadPool.submit(() -&gt; {</b>
<i class="no-highlight">423</i>&nbsp;            try {
<b class="nc"><i class="no-highlight">424</i>&nbsp;                return connection.createSession(isTransacted, ackMode);</b>
<b class="nc"><i class="no-highlight">425</i>&nbsp;            } catch (JMSException e3) {</b>
<b class="nc"><i class="no-highlight">426</i>&nbsp;                throw new SnapDataException(e3, ERROR_WHILE_CREATING_SESSION)</b>
<b class="nc"><i class="no-highlight">427</i>&nbsp;                        .withReason(e3.getMessage())</b>
<b class="nc"><i class="no-highlight">428</i>&nbsp;                        .withResolutionAsDefect();</b>
<i class="no-highlight">429</i>&nbsp;            }
<i class="no-highlight">430</i>&nbsp;        });
<i class="no-highlight">431</i>&nbsp;
<i class="no-highlight">432</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">433</i>&nbsp;            return result.get(10L, TimeUnit.SECONDS);</b>
<b class="nc"><i class="no-highlight">434</i>&nbsp;        } catch (InterruptedException | java.util.concurrent.ExecutionException e1) {</b>
<b class="nc"><i class="no-highlight">435</i>&nbsp;            result.cancel(true);</b>
<b class="nc"><i class="no-highlight">436</i>&nbsp;            throw new SnapDataException(e1, COULD_NOT_CREATE_SESSION)</b>
<b class="nc"><i class="no-highlight">437</i>&nbsp;                    .withResolution(JMS_ERROR_RESOLUTION);</b>
<b class="nc"><i class="no-highlight">438</i>&nbsp;        } catch (Exception e2) {</b>
<b class="nc"><i class="no-highlight">439</i>&nbsp;            result.cancel(true);</b>
<b class="nc"><i class="no-highlight">440</i>&nbsp;            throw new SnapDataException(e2, COULD_NOT_CREATE_SESSION)</b>
<b class="nc"><i class="no-highlight">441</i>&nbsp;                    .withResolution(PLEASE_CHECK_ACCOUNT_SETTINGS);</b>
<i class="no-highlight">442</i>&nbsp;        } finally {
<b class="nc"><i class="no-highlight">443</i>&nbsp;            shutdownThreadPoolAndAwaitTermination(threadPool);</b>
<b class="nc"><i class="no-highlight">444</i>&nbsp;        }</b>
<i class="no-highlight">445</i>&nbsp;    }
<i class="no-highlight">446</i>&nbsp;
<i class="no-highlight">447</i>&nbsp;    // The following method shuts down an ExecutorService in two phases, first by calling
<i class="no-highlight">448</i>&nbsp;    // shutdown to reject incoming tasks, and then calling shutdownNow, if necessary, to cancel
<i class="no-highlight">449</i>&nbsp;    // any lingering tasks
<i class="no-highlight">450</i>&nbsp;    // from https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ExecutorService.html
<i class="no-highlight">451</i>&nbsp;    private void shutdownThreadPoolAndAwaitTermination(final ExecutorService pool) {
<b class="nc"><i class="no-highlight">452</i>&nbsp;        pool.shutdown();</b>
<i class="no-highlight">453</i>&nbsp;        try {
<i class="no-highlight">454</i>&nbsp;            // wait a while for existing tasks to terminate
<b class="nc"><i class="no-highlight">455</i>&nbsp;            if (!pool.awaitTermination(15, TimeUnit.SECONDS)) {</b>
<i class="no-highlight">456</i>&nbsp;                // timeout elapsed; cancel currently executing tasks
<b class="nc"><i class="no-highlight">457</i>&nbsp;                pool.shutdownNow();</b>
<i class="no-highlight">458</i>&nbsp;                // wait a while for tasks to respond to being cancelled
<b class="nc"><i class="no-highlight">459</i>&nbsp;                if (!pool.awaitTermination(15, TimeUnit.SECONDS))</b>
<b class="nc"><i class="no-highlight">460</i>&nbsp;                    LOG.error(&quot;Thread pool did not terminate when verifying connection&quot;);</b>
<i class="no-highlight">461</i>&nbsp;            }
<b class="nc"><i class="no-highlight">462</i>&nbsp;        } catch (InterruptedException ie) {</b>
<i class="no-highlight">463</i>&nbsp;            // cancel (again) if current thread was also interrupted
<b class="nc"><i class="no-highlight">464</i>&nbsp;            pool.shutdownNow();</b>
<i class="no-highlight">465</i>&nbsp;            // preserve interrupt status
<b class="nc"><i class="no-highlight">466</i>&nbsp;            Thread.currentThread().interrupt();</b>
<b class="nc"><i class="no-highlight">467</i>&nbsp;        }</b>
<i class="no-highlight">468</i>&nbsp;    }
<i class="no-highlight">469</i>&nbsp;
<i class="no-highlight">470</i>&nbsp;    @Override
<i class="no-highlight">471</i>&nbsp;    public void disconnect() throws SnapDataException {
<b class="nc"><i class="no-highlight">472</i>&nbsp;        if (asyncMode) {</b>
<i class="no-highlight">473</i>&nbsp;            // Since we have separate distinct connection and sessions for async mode,
<i class="no-highlight">474</i>&nbsp;            //   they will be closed here
<i class="no-highlight">475</i>&nbsp;            try {
<b class="nc"><i class="no-highlight">476</i>&nbsp;                if (sessions[0] != null) {</b>
<b class="nc"><i class="no-highlight">477</i>&nbsp;                    sessions[0].close();</b>
<i class="no-highlight">478</i>&nbsp;                }
<b class="nc"><i class="no-highlight">479</i>&nbsp;                if (sessions[1] != null) {</b>
<b class="nc"><i class="no-highlight">480</i>&nbsp;                    sessions[1].close();</b>
<i class="no-highlight">481</i>&nbsp;                }
<b class="nc"><i class="no-highlight">482</i>&nbsp;            } catch (JMSException e1) {</b>
<b class="nc"><i class="no-highlight">483</i>&nbsp;                LOG.error(&quot;Error while closing session {}&quot;, e1.getMessage(), e1);</b>
<b class="nc"><i class="no-highlight">484</i>&nbsp;            }</b>
<i class="no-highlight">485</i>&nbsp;            try {
<b class="nc"><i class="no-highlight">486</i>&nbsp;                if (connection != null) {</b>
<b class="nc"><i class="no-highlight">487</i>&nbsp;                    connection.stop();</b>
<b class="nc"><i class="no-highlight">488</i>&nbsp;                    connection.close();</b>
<i class="no-highlight">489</i>&nbsp;                }
<b class="nc"><i class="no-highlight">490</i>&nbsp;            } catch (JMSException e1) {</b>
<b class="nc"><i class="no-highlight">491</i>&nbsp;                LOG.error(&quot;Error while closing connection {}&quot;, e1.getMessage(), e1);</b>
<b class="nc"><i class="no-highlight">492</i>&nbsp;            }</b>
<i class="no-highlight">493</i>&nbsp;        } else {
<i class="no-highlight">494</i>&nbsp;            // Handling closing of shared connections
<b class="nc"><i class="no-highlight">495</i>&nbsp;            closeSessionRequest(sessions[0], sessionsConnectionID[0]);</b>
<b class="nc"><i class="no-highlight">496</i>&nbsp;            if (controlSessionRequired) {</b>
<b class="nc"><i class="no-highlight">497</i>&nbsp;                closeSessionRequest(sessions[1], sessionsConnectionID[1]);</b>
<i class="no-highlight">498</i>&nbsp;            }
<i class="no-highlight">499</i>&nbsp;        }
<i class="no-highlight">500</i>&nbsp;        // Settings the sessions and connection to null so that there is no mess in case
<i class="no-highlight">501</i>&nbsp;        //   disconnect() is called again
<b class="nc"><i class="no-highlight">502</i>&nbsp;        sessions[0] = null;</b>
<b class="nc"><i class="no-highlight">503</i>&nbsp;        sessions[1] = null;</b>
<b class="nc"><i class="no-highlight">504</i>&nbsp;        connection = null;</b>
<i class="no-highlight">505</i>&nbsp;    }
<i class="no-highlight">506</i>&nbsp;
<i class="no-highlight">507</i>&nbsp;    /**
<i class="no-highlight">508</i>&nbsp;     * Closes the given session.
<i class="no-highlight">509</i>&nbsp;     * And also the associated connection if no longer needed.
<i class="no-highlight">510</i>&nbsp;     *
<i class="no-highlight">511</i>&nbsp;     * @param session
<i class="no-highlight">512</i>&nbsp;     * @param connectionID
<i class="no-highlight">513</i>&nbsp;     */
<i class="no-highlight">514</i>&nbsp;    private void closeSessionRequest(Session session, String connectionID) {
<b class="nc"><i class="no-highlight">515</i>&nbsp;        if (session != null) {</b>
<i class="no-highlight">516</i>&nbsp;            try {
<i class="no-highlight">517</i>&nbsp;                // Close the given session
<b class="nc"><i class="no-highlight">518</i>&nbsp;                session.close();</b>
<b class="nc"><i class="no-highlight">519</i>&nbsp;            } catch (JMSException e1) {</b>
<b class="nc"><i class="no-highlight">520</i>&nbsp;                LOG.error(ERROR_WHILE_CLOSING_SESSION, e1);</b>
<i class="no-highlight">521</i>&nbsp;            } finally {
<b class="nc"><i class="no-highlight">522</i>&nbsp;                Map&lt;String, Connection&gt; jmsConnections;</b>
<i class="no-highlight">523</i>&nbsp;                try {
<b class="nc"><i class="no-highlight">524</i>&nbsp;                    jmsConnections = JMS_CONNECTIONS_CACHE.get(connectionProperties);</b>
<i class="no-highlight">525</i>&nbsp;                    // Allow only one thread at a time (among threads with same configuration) to
<i class="no-highlight">526</i>&nbsp;                    //  the critical section
<b class="nc"><i class="no-highlight">527</i>&nbsp;                    synchronized (jmsConnections) {</b>
<i class="no-highlight">528</i>&nbsp;                        // Update the no of sessions for the connection used
<i class="no-highlight">529</i>&nbsp;                        // If the updated count for the connection is zero then we will stop/close
<i class="no-highlight">530</i>&nbsp;                        //  the connection as well
<b class="nc"><i class="no-highlight">531</i>&nbsp;                        int sessionsCount = SESSIONS_PER_CONNECTION.get(connectionID).getCount();</b>
<b class="nc"><i class="no-highlight">532</i>&nbsp;                        if (sessionsCount == 1) {</b>
<i class="no-highlight">533</i>&nbsp;                            // Only one session; so connection needs to be removed from the cache
<i class="no-highlight">534</i>&nbsp;                            // and closed
<b class="nc"><i class="no-highlight">535</i>&nbsp;                            SESSIONS_PER_CONNECTION.remove(connectionID);</b>
<b class="nc"><i class="no-highlight">536</i>&nbsp;                            Connection connection = jmsConnections.remove(connectionID);</b>
<i class="no-highlight">537</i>&nbsp;                            try {
<i class="no-highlight">538</i>&nbsp;                                // stop the connection
<b class="nc"><i class="no-highlight">539</i>&nbsp;                                connection.stop();</b>
<b class="nc"><i class="no-highlight">540</i>&nbsp;                                LOG.info(&quot;An instance of connection bearing the Client ID &#39;{}&#39; &quot; +</b>
<i class="no-highlight">541</i>&nbsp;                                        &quot;has been stopped&quot;, clientID);
<b class="nc"><i class="no-highlight">542</i>&nbsp;                            } catch (JMSException e2) {</b>
<b class="nc"><i class="no-highlight">543</i>&nbsp;                                LOG.error(String.format(ERROR_WHILE_STOPPING_CONNECTION, clientID),</b>
<i class="no-highlight">544</i>&nbsp;                                        e2);
<b class="nc"><i class="no-highlight">545</i>&nbsp;                            }</b>
<i class="no-highlight">546</i>&nbsp;                            try {
<i class="no-highlight">547</i>&nbsp;                                // close the connection
<b class="nc"><i class="no-highlight">548</i>&nbsp;                                connection.close();</b>
<b class="nc"><i class="no-highlight">549</i>&nbsp;                                LOG.info(&quot;An instance of connection bearing the Client ID &#39;{}&#39; &quot; +</b>
<i class="no-highlight">550</i>&nbsp;                                        &quot;has been closed&quot;, clientID);
<b class="nc"><i class="no-highlight">551</i>&nbsp;                            } catch (JMSException e3) {</b>
<b class="nc"><i class="no-highlight">552</i>&nbsp;                                LOG.error(String.format(ERROR_WHILE_CLOSING_CONNECTION, clientID),</b>
<i class="no-highlight">553</i>&nbsp;                                        e3);
<b class="nc"><i class="no-highlight">554</i>&nbsp;                            }</b>
<b class="nc"><i class="no-highlight">555</i>&nbsp;                        } else {</b>
<i class="no-highlight">556</i>&nbsp;                            // Decrement the sessions count by one
<b class="nc"><i class="no-highlight">557</i>&nbsp;                            SESSIONS_PER_CONNECTION.get(connectionID).decr();</b>
<i class="no-highlight">558</i>&nbsp;                        }
<b class="nc"><i class="no-highlight">559</i>&nbsp;                    }</b>
<b class="nc"><i class="no-highlight">560</i>&nbsp;                } catch (java.util.concurrent.ExecutionException e4) {</b>
<b class="nc"><i class="no-highlight">561</i>&nbsp;                    LOG.error(&quot;Error while trying to read cache to close the connection&quot;,</b>
<i class="no-highlight">562</i>&nbsp;                            e4);
<b class="nc"><i class="no-highlight">563</i>&nbsp;                }</b>
<b class="nc"><i class="no-highlight">564</i>&nbsp;            }</b>
<i class="no-highlight">565</i>&nbsp;        }
<i class="no-highlight">566</i>&nbsp;    }
<i class="no-highlight">567</i>&nbsp;
<i class="no-highlight">568</i>&nbsp;    @Override
<i class="no-highlight">569</i>&nbsp;    public void configure(final PropertyValues propertyValues) {
<b class="nc"><i class="no-highlight">570</i>&nbsp;        List&lt;Map&lt;String, Object&gt;&gt; jndiProperties =</b>
<b class="nc"><i class="no-highlight">571</i>&nbsp;                propertyValues.get(JNDI_PROPERTIES_PROP);</b>
<b class="nc"><i class="no-highlight">572</i>&nbsp;        List&lt;Map&lt;String, Object&gt;&gt; jars = propertyValues.get(JARS_TABLE_PROP);</b>
<b class="nc"><i class="no-highlight">573</i>&nbsp;        if (CollectionUtils.isEmpty(jars)) {</b>
<b class="nc"><i class="no-highlight">574</i>&nbsp;            throw new ConfigurationException(NO_JAR)</b>
<b class="nc"><i class="no-highlight">575</i>&nbsp;                    .withReason(NO_JAR)</b>
<b class="nc"><i class="no-highlight">576</i>&nbsp;                    .withResolution(NO_JAR_RESOLUTION);</b>
<i class="no-highlight">577</i>&nbsp;        }
<i class="no-highlight">578</i>&nbsp;        try {
<b class="nc"><i class="no-highlight">579</i>&nbsp;            List&lt;URL&gt; jarFiles = new ArrayList&lt;&gt;();</b>
<b class="nc"><i class="no-highlight">580</i>&nbsp;            for (Map&lt;String, Object&gt; map : jars) {</b>
<b class="nc"><i class="no-highlight">581</i>&nbsp;                ExpressionProperty fileExpression = propertyValues</b>
<b class="nc"><i class="no-highlight">582</i>&nbsp;                        .getExpressionPropertyFor(map, JAR_FILE_PROP);</b>
<b class="nc"><i class="no-highlight">583</i>&nbsp;                String fileExpressionValue = fileExpression.eval(null);</b>
<b class="nc"><i class="no-highlight">584</i>&nbsp;                if (StringUtils.isBlank(fileExpressionValue)) {</b>
<b class="nc"><i class="no-highlight">585</i>&nbsp;                    continue;</b>
<i class="no-highlight">586</i>&nbsp;                }
<b class="nc"><i class="no-highlight">587</i>&nbsp;                jarFiles.add(urlEncoder.validateAndEncodeURI(fileExpressionValue).toURL());</b>
<b class="nc"><i class="no-highlight">588</i>&nbsp;            }</b>
<b class="nc"><i class="no-highlight">589</i>&nbsp;            StringBuilder keyBuilder = new StringBuilder();</b>
<b class="nc"><i class="no-highlight">590</i>&nbsp;            for (URL jarFile : jarFiles) {</b>
<b class="nc"><i class="no-highlight">591</i>&nbsp;                keyBuilder.append(jarFile.toString());</b>
<b class="nc"><i class="no-highlight">592</i>&nbsp;                keyBuilder.append(PIPE_SEPARATOR);</b>
<b class="nc"><i class="no-highlight">593</i>&nbsp;            }</b>
<b class="nc"><i class="no-highlight">594</i>&nbsp;            String key = keyBuilder.toString();</b>
<b class="nc"><i class="no-highlight">595</i>&nbsp;            Properties jndiProps = null;</b>
<b class="nc"><i class="no-highlight">596</i>&nbsp;            Context context = null;</b>
<b class="nc"><i class="no-highlight">597</i>&nbsp;            ClassLoader classLoader = null;</b>
<b class="nc"><i class="no-highlight">598</i>&nbsp;            String connectionFactoryNamesProp = StringUtils.EMPTY;</b>
<i class="no-highlight">599</i>&nbsp;            try {
<b class="nc"><i class="no-highlight">600</i>&nbsp;                LOCK.lock();</b>
<b class="nc"><i class="no-highlight">601</i>&nbsp;                jndiProps = convert(jndiProperties);</b>
<i class="no-highlight">602</i>&nbsp;
<i class="no-highlight">603</i>&nbsp;                // NOTE: The temporary fix for SNAP-3809, is to disable the SldbJarClassloader, and
<i class="no-highlight">604</i>&nbsp;                // instead use the jar from tectonic dependency through SnapClassLoader, but the
<i class="no-highlight">605</i>&nbsp;                // ideal fix for this should be PLAT-3186
<i class="no-highlight">606</i>&nbsp;                // NOTE 2: The previous fix for SNAP-3809, ignores all the jars that were uploaded
<i class="no-highlight">607</i>&nbsp;                // but which made the accounts that were using the different ContextFactory
<i class="no-highlight">608</i>&nbsp;                // implementation for other jar like Jboss. The fix is to use the snapclassloader
<i class="no-highlight">609</i>&nbsp;                // only for the ActiveMq ContextFactory which is already available in the
<i class="no-highlight">610</i>&nbsp;                // Tectonic dependency. (Still a Temporary Fix)
<b class="nc"><i class="no-highlight">611</i>&nbsp;                classLoader = CLASS_LOADERS.get(key);</b>
<b class="nc"><i class="no-highlight">612</i>&nbsp;                if (classLoader == null) {</b>
<b class="nc"><i class="no-highlight">613</i>&nbsp;                    classLoader = createURLClassloader(jarFiles.toArray(new URL[0]), jndiProps);</b>
<b class="nc"><i class="no-highlight">614</i>&nbsp;                    CLASS_LOADERS.put(key, classLoader);</b>
<i class="no-highlight">615</i>&nbsp;                }
<b class="nc"><i class="no-highlight">616</i>&nbsp;                Thread.currentThread().setContextClassLoader(classLoader);</b>
<b class="nc"><i class="no-highlight">617</i>&nbsp;                connectionFactoryName = propertyValues.get(CONNECTION_FACTORY_NAME_PROP);</b>
<b class="nc"><i class="no-highlight">618</i>&nbsp;                username = propertyValues.get(USERNAME_PROP);</b>
<b class="nc"><i class="no-highlight">619</i>&nbsp;                password = propertyValues.get(PASSWORD_PROP);</b>
<i class="no-highlight">620</i>&nbsp;
<b class="nc"><i class="no-highlight">621</i>&nbsp;                Properties propertiesKey = new Properties();</b>
<b class="nc"><i class="no-highlight">622</i>&nbsp;                propertiesKey.putAll(jndiProps);</b>
<b class="nc"><i class="no-highlight">623</i>&nbsp;                if (StringUtils.isNotBlank(username)) {</b>
<b class="nc"><i class="no-highlight">624</i>&nbsp;                    propertiesKey.put(USERNAME, username);</b>
<i class="no-highlight">625</i>&nbsp;                }
<b class="nc"><i class="no-highlight">626</i>&nbsp;                if (StringUtils.isNotBlank(password)) {</b>
<b class="nc"><i class="no-highlight">627</i>&nbsp;                    propertiesKey.put(PASSWORD, password);</b>
<i class="no-highlight">628</i>&nbsp;                }
<b class="nc"><i class="no-highlight">629</i>&nbsp;                if (StringUtils.isNotBlank(connectionFactoryName)) {</b>
<b class="nc"><i class="no-highlight">630</i>&nbsp;                    propertiesKey.put(CONNECTION_FACTORY_NAME, connectionFactoryName);</b>
<i class="no-highlight">631</i>&nbsp;                }
<b class="nc"><i class="no-highlight">632</i>&nbsp;                connectionProperties = new ImmutableMap.Builder&lt;String, String&gt;()</b>
<b class="nc"><i class="no-highlight">633</i>&nbsp;                        .putAll((Map) propertiesKey)</b>
<b class="nc"><i class="no-highlight">634</i>&nbsp;                        .build();</b>
<i class="no-highlight">635</i>&nbsp;
<b class="nc"><i class="no-highlight">636</i>&nbsp;                connectionFactoryNamesProp = jndiProps</b>
<b class="nc"><i class="no-highlight">637</i>&nbsp;                        .getProperty(&quot;connectionFactoryNames&quot;);</b>
<b class="nc"><i class="no-highlight">638</i>&nbsp;                context = administeredObjectsUtil.createInitialContext(</b>
<i class="no-highlight">639</i>&nbsp;                        jndiProps, classLoader);
<b class="nc"><i class="no-highlight">640</i>&nbsp;                connectionFactory = administeredObjectsUtil.fetchConnectionFactory(</b>
<i class="no-highlight">641</i>&nbsp;                        context, connectionFactoryName, connectionFactoryNamesProp);
<b class="nc"><i class="no-highlight">642</i>&nbsp;            } catch (SnapException snapEx) {</b>
<b class="nc"><i class="no-highlight">643</i>&nbsp;                Throwable cause = Throwables.getRootCause(snapEx);</b>
<b class="nc"><i class="no-highlight">644</i>&nbsp;                if (cause != null &amp;&amp; JNDI_LOOKUP_ERRORS.stream().anyMatch(error_key -&gt;</b>
<b class="nc"><i class="no-highlight">645</i>&nbsp;                                StringUtils.containsIgnoreCase(cause.getMessage(), error_key))) {</b>
<i class="no-highlight">646</i>&nbsp;                    // Give it a try by adding username and password as JNDI properties
<i class="no-highlight">647</i>&nbsp;                    // Some messages brokers like Solace are failing either to initialize context
<i class="no-highlight">648</i>&nbsp;                    // or fetch connection factory if credentials not passed as JNDI properties
<b class="nc"><i class="no-highlight">649</i>&nbsp;                    LOG.info(&quot;Connection Factory lookup failed, retrying with adding &quot; +</b>
<i class="no-highlight">650</i>&nbsp;                            &quot;java.naming.security.principal and java.naming.security.credentials &quot; +
<i class="no-highlight">651</i>&nbsp;                            &quot;JNDI properties&quot;);
<b class="nc"><i class="no-highlight">652</i>&nbsp;                    jndiProps.putIfAbsent(&quot;java.naming.security.principal&quot;, username);</b>
<b class="nc"><i class="no-highlight">653</i>&nbsp;                    jndiProps.putIfAbsent(&quot;java.naming.security.credentials&quot;, password);</b>
<b class="nc"><i class="no-highlight">654</i>&nbsp;                    context = administeredObjectsUtil.createInitialContext(</b>
<i class="no-highlight">655</i>&nbsp;                            jndiProps, classLoader);
<b class="nc"><i class="no-highlight">656</i>&nbsp;                    connectionFactory = administeredObjectsUtil.fetchConnectionFactory(</b>
<i class="no-highlight">657</i>&nbsp;                            context, connectionFactoryName, connectionFactoryNamesProp);
<i class="no-highlight">658</i>&nbsp;                } else {
<b class="nc"><i class="no-highlight">659</i>&nbsp;                    throw snapEx;</b>
<i class="no-highlight">660</i>&nbsp;                }
<i class="no-highlight">661</i>&nbsp;            } finally {
<b class="nc"><i class="no-highlight">662</i>&nbsp;                LOCK.unlock();</b>
<b class="nc"><i class="no-highlight">663</i>&nbsp;            }</b>
<b class="nc"><i class="no-highlight">664</i>&nbsp;        } catch (MalformedURLException e1) {</b>
<b class="nc"><i class="no-highlight">665</i>&nbsp;            throw new ConfigurationException(e1, JAR_ERROR_MSG)</b>
<b class="nc"><i class="no-highlight">666</i>&nbsp;                    .withReason(e1.getMessage())</b>
<b class="nc"><i class="no-highlight">667</i>&nbsp;                    .withResolution(JAR_ERROR_RESOLUTION);</b>
<b class="nc"><i class="no-highlight">668</i>&nbsp;        }</b>
<i class="no-highlight">669</i>&nbsp;    }
<i class="no-highlight">670</i>&nbsp;
<i class="no-highlight">671</i>&nbsp;    /**
<i class="no-highlight">672</i>&nbsp;     * Creates a new classloader that can dynamically load the JMS classes
<i class="no-highlight">673</i>&nbsp;     */
<i class="no-highlight">674</i>&nbsp;    private ClassLoader createURLClassloader(URL[] jarUrls, Properties jndiProps) {
<b class="nc"><i class="no-highlight">675</i>&nbsp;        ClassLoader currentClassLoader = Thread.currentThread().getContextClassLoader();</b>
<b class="nc"><i class="no-highlight">676</i>&nbsp;        return new OldSldbJarClassloader(jarUrls, currentClassLoader, jndiProps);</b>
<i class="no-highlight">677</i>&nbsp;    }
<i class="no-highlight">678</i>&nbsp;
<i class="no-highlight">679</i>&nbsp;    private Properties convert(List&lt;Map&lt;String, Object&gt;&gt; jndiProperties) {
<b class="nc"><i class="no-highlight">680</i>&nbsp;        Properties jndi = new Properties();</b>
<b class="nc"><i class="no-highlight">681</i>&nbsp;        if (jndiProperties != null) {</b>
<b class="nc"><i class="no-highlight">682</i>&nbsp;            for (Map&lt;String, Object&gt; map : jndiProperties) {</b>
<b class="nc"><i class="no-highlight">683</i>&nbsp;                jndi.put(JsonPath.read(map, JNDI_PROPERTY_NAME_PATH),</b>
<b class="nc"><i class="no-highlight">684</i>&nbsp;                        JsonPath.read(map, JNDI_PROPERTY_VALUE_PATH));</b>
<b class="nc"><i class="no-highlight">685</i>&nbsp;            }</b>
<i class="no-highlight">686</i>&nbsp;        }
<b class="nc"><i class="no-highlight">687</i>&nbsp;        return jndi;</b>
<i class="no-highlight">688</i>&nbsp;    }
<i class="no-highlight">689</i>&nbsp;
<i class="no-highlight">690</i>&nbsp;    /**
<i class="no-highlight">691</i>&nbsp;     * While creating a connection/session, we need certain properties.
<i class="no-highlight">692</i>&nbsp;     * These properties are decided in the snaps.
<i class="no-highlight">693</i>&nbsp;     * As the connection/session creation happens in the account, we need to store those properties
<i class="no-highlight">694</i>&nbsp;     * here.
<i class="no-highlight">695</i>&nbsp;     *
<i class="no-highlight">696</i>&nbsp;     * @param isTransacted
<i class="no-highlight">697</i>&nbsp;     * @param ackMode
<i class="no-highlight">698</i>&nbsp;     * @param clientID
<i class="no-highlight">699</i>&nbsp;     * @param durableSubscriber
<i class="no-highlight">700</i>&nbsp;     * @param controlSessionRequired
<i class="no-highlight">701</i>&nbsp;     * @param asyncMode
<i class="no-highlight">702</i>&nbsp;     */
<i class="no-highlight">703</i>&nbsp;    public void setConnectionSessionProps(boolean isTransacted, int ackMode, String clientID,
<i class="no-highlight">704</i>&nbsp;            boolean durableSubscriber, boolean controlSessionRequired, boolean asyncMode) {
<b class="nc"><i class="no-highlight">705</i>&nbsp;        this.isTransacted = isTransacted;</b>
<b class="nc"><i class="no-highlight">706</i>&nbsp;        this.ackMode = ackMode;</b>
<b class="nc"><i class="no-highlight">707</i>&nbsp;        this.clientID = clientID;</b>
<b class="nc"><i class="no-highlight">708</i>&nbsp;        this.durableSubscriber = durableSubscriber;</b>
<b class="nc"><i class="no-highlight">709</i>&nbsp;        this.controlSessionRequired = controlSessionRequired;</b>
<b class="nc"><i class="no-highlight">710</i>&nbsp;        this.asyncMode = asyncMode;</b>
<i class="no-highlight">711</i>&nbsp;    }
<i class="no-highlight">712</i>&nbsp;
<i class="no-highlight">713</i>&nbsp;    /**
<i class="no-highlight">714</i>&nbsp;     * Returns the control session
<i class="no-highlight">715</i>&nbsp;     *
<i class="no-highlight">716</i>&nbsp;     * @return instance of Session
<i class="no-highlight">717</i>&nbsp;     */
<i class="no-highlight">718</i>&nbsp;    public Session getControlSession() {
<b class="nc"><i class="no-highlight">719</i>&nbsp;        return sessions[1];</b>
<i class="no-highlight">720</i>&nbsp;    }
<i class="no-highlight">721</i>&nbsp;
<i class="no-highlight">722</i>&nbsp;    /**
<i class="no-highlight">723</i>&nbsp;     * Returns the connection instance
<i class="no-highlight">724</i>&nbsp;     *
<i class="no-highlight">725</i>&nbsp;     * @return connection
<i class="no-highlight">726</i>&nbsp;     */
<i class="no-highlight">727</i>&nbsp;    public Connection getConnection() {
<b class="nc"><i class="no-highlight">728</i>&nbsp;        return connection;</b>
<i class="no-highlight">729</i>&nbsp;    }
<i class="no-highlight">730</i>&nbsp;}
</div>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
        var codeBlock = document.getElementById('sourceCode');

        if (codeBlock) {
            hljs.highlightBlock(codeBlock);
        }
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-01-19 15:49</div>
</div>
</body>
</html>
